(function(f){var d=false,c=true;if(!("SPDemographic" in f))return;var b={defaultXid:"00000000-0000-0000-0000-000000000000",serverName:"spdmg-backend.i-mobile.co.jp",handler_tk_idgenerator:"tr_xid.ashx",handler_tk_visit:"tr_visit.ashx",xidUngeneratableUserTrafficRatio:parseFloat("0.1"),interval:parseInt("60000",10),scheme:document.location.protocol=="http:"?"http":"https",lastRequestTimeKey:"Lrt",adSpotIdKey:"asid",xIdKey:"xid"};b.url_tk_idgenerator=b.scheme+"://"+b.serverName+"/"+b.handler_tk_idgenerator;b.url_tk_visit=b.scheme+"://"+b.serverName+"/"+b.handler_tk_visit;b.url_sync=b.scheme+"://"+b.serverName+"/script/sync.js";var a={INIT:1001,CHECK_OPTOUT:1002,IS_GENERATABLE_XID:1003,IS_EXIST_XID:1004,CONTROL_TRAFFIC:1005,IS_EXIST_LRT:1006,REQUEST_XID_GENERATE:1007,CHECK_FREQUENCY:1008,TOO_FREQUENT:1009,REQUEST_SITEVISIT:1010,CHECK_RAND:1011,NO_REQUEST:1012,REQUEST_NO_XID_USER:1013,END:2001},g={ERROR:1e4,NO_XID_REFUSED:10001,NO_XID_VISITED:10002,XID_GENERATE:10003,XID_VISITED:10004,BUSY:10005,XID_OPTOUT:10006},k=new n,e=f.SPDemographic.createStorageInstance("i-mobile.co.jp",parseInt("730",10)),h=f.SPDemographic.createHttpConnectionInstance();function j(){}j.prototype=f.SPDemographic.createHttpConnectionCallbackInstance();j.prototype.onSuccess=function(b){var c=b.replace(/["'{}\s]/g,""),a=c.split(":");a.length==2&&e.setItem(a[0],a[1]);k.requestSync()};function i(){}i.prototype=f.SPDemographic.createHttpConnectionCallbackInstance();i.prototype.onSuccess=function(){var a=m();e.setItem(b.lastRequestTimeKey,String(a));k.requestSync()};function m(){var a=new Date;return a.getTime()}function n(){var a=null,g=this;g.initialize=function(b){this.adSpotID=b;this.rand=a};g.storageEnable=function(){return e.available()};g.createRandomNumber=function(){this.rand=Math.random()};g.getRandomNumber=function(){this.rand==a&&this.createRandomNumber();return this.rand};g.isRegulateTraffic=function(){if(this.getRandomNumber()>b.xidUngeneratableUserTrafficRatio)return c;else return d};g.getTrafficRatio=function(){return b.xidUngeneratableUserTrafficRatio};g.getAdSpotId=function(){return this.adSpotID};g.userVisit=function(){var d=new i,g=this.getAdSpotId(),c=e.getItem(b.xIdKey);if(c==a)c=b.defaultXid;var f=b.adSpotIdKey+"="+g+"&"+b.xIdKey+"="+c,j=b.url_tk_visit;h.connectToServerAsync(j+"?"+f,d)};g.xidUngeneratableUserVisit=function(){var d=this.getAdSpotId(),f=b.defaultXid,c=b.adSpotIdKey+"="+d+"&"+b.xIdKey+"="+f,e=b.url_tk_visit;h.connectToServerAsync(e+"?"+c,a)};g.requestXidGenerate=function(){var a=new j,d=this.getAdSpotId(),e=b.url_tk_idgenerator,c=b.adSpotIdKey+"="+d;h.connectToServerAsync(e+"?"+c,a)};g.requestSync=function(){e.needSync(b.xIdKey)&&setTimeout(function(){var a=document.createElement("script");a.type="text/javascript";a.src=b.url_sync;document.body.appendChild(a)},0)};g.getResponseText=function(){return h.getResponseText()};g.isExistXid=function(){if(e.getItem(b.xIdKey)==a)return d;else return c};g.isExistLastRequestTime=function(){if(e.getItem(b.lastRequestTimeKey)==a)return d;else return c};g.isSufficientInterval=function(){if(this.getTimeDifference()>b.interval)return c;else return d};g.getTimeDifference=function(){var c=e.getItem(b.lastRequestTimeKey);if(c==a)return b.interval+1;var f=parseInt(c,10),d=(new Date).getTime();return d-f};g.isOptOut=function(a){var b=f.SPDemographic.isOptOut(a);if(b==c)return c;else return d}}function l(){var f=this;f.execute=function(a){this.initialize(a);this.execAllTask()};f.getResultCode=function(){return this.resultCode};f.initialize=function(c){var b=this;b.currentState=a.INIT;b.resultCode=g.ERROR;b.siteVisitModule=k;b.siteVisitModule.initialize(c)};f.execAllTask=function(){while(this.currentState!=a.END)this.execTask();this.currentState=a.INIT};f.execTask=function(){var f=this;switch(f.currentState){case a.INIT:f.currentState=a.CHECK_OPTOUT;break;case a.CHECK_OPTOUT:if(f.siteVisitModule.isOptOut(e)==c){f.currentState=a.END;f.resultCode=g.XID_OPTOUT;break}else{f.currentState=a.IS_GENERATABLE_XID;break}case a.IS_GENERATABLE_XID:if(f.siteVisitModule.storageEnable()==c)f.currentState=a.IS_EXIST_XID;else f.currentState=a.CONTROL_TRAFFIC;break;case a.CONTROL_TRAFFIC:f.siteVisitModule.createRandomNumber();f.currentState=a.CHECK_RAND;break;case a.CHECK_RAND:if(f.siteVisitModule.isRegulateTraffic()==c)f.currentState=a.NO_REQUEST;else f.currentState=a.REQUEST_NO_XID_USER;break;case a.NO_REQUEST:f.currentState=a.END;f.resultCode=g.NO_XID_REFUSED;break;case a.REQUEST_NO_XID_USER:f.siteVisitModule.xidUngeneratableUserVisit();f.currentState=a.END;f.resultCode=g.NO_XID_VISITED;break;case a.IS_EXIST_XID:if(f.siteVisitModule.isExistXid()==d)f.currentState=a.REQUEST_XID_GENERATE;else{e.innerSync(b.xIdKey);e.innerSync(b.lastRequestTimeKey);f.currentState=a.IS_EXIST_LRT}break;case a.REQUEST_XID_GENERATE:f.siteVisitModule.requestXidGenerate();f.currentState=a.END;f.resultCode=g.XID_GENERATE;break;case a.IS_EXIST_LRT:if(f.siteVisitModule.isExistLastRequestTime()==d)f.currentState=a.REQUEST_SITEVISIT;else f.currentState=a.CHECK_FREQUENCY;break;case a.REQUEST_SITEVISIT:f.siteVisitModule.userVisit();f.currentState=a.END;f.resultCode=g.XID_VISITED;break;case a.CHECK_FREQUENCY:if(f.siteVisitModule.isSufficientInterval()==c)f.currentState=a.REQUEST_SITEVISIT;else f.currentState=a.TOO_FREQUENT;break;case a.TOO_FREQUENT:f.currentState=a.END;f.resultCode=g.BUSY}}}f.SPDemographic.createSiteVisitInstance=function(){return new l}})(window)